<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GastroLogic | AI Powered</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        chef: { 500: '#FF6B6B', 600: '#EE5253' },
                        dark: '#2D3436',
                        light: '#F7F9FC'
                    },
                    fontFamily: { sans: ['Inter', 'sans-serif'] }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap');
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        /* Markdown Styles para la respuesta de la IA */
        .prose p { margin-bottom: 0.5rem; font-size: 0.85rem; line-height: 1.4; }
        .prose ul { list-style-type: disc; padding-left: 1rem; margin-bottom: 0.5rem; }
        .prose strong { color: #FF6B6B; font-weight: 800; }
        .loader { border: 2px solid #f3f3f3; border-top: 2px solid #FF6B6B; border-radius: 50%; width: 16px; height: 16px; animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-light text-dark h-screen flex flex-col overflow-hidden" x-data="app()">

    <header class="bg-white px-5 py-4 flex justify-between items-center shadow-sm z-20 shrink-0">
        <div class="flex items-center gap-3">
            <div class="bg-dark text-white p-2 rounded-xl">
                <i data-lucide="brain-circuit" class="w-5 h-5"></i>
            </div>
            <div>
                <h1 class="font-black text-lg leading-none tracking-tight">GastroLogic</h1>
                <p class="text-[10px] text-gray-400 font-bold tracking-widest uppercase mt-0.5">Gesti√≥n Inteligente</p>
            </div>
        </div>
        <div class="bg-green-50 text-green-700 px-3 py-1 rounded-full text-[10px] font-bold border border-green-200 flex items-center gap-1">
            <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div> Online
        </div>
    </header>

    <main class="flex-1 overflow-y-auto hide-scrollbar relative p-4 pb-24">
        
        <div x-show="view === 'stock'" class="space-y-4">
            <div class="grid grid-cols-2 gap-3">
                <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100">
                    <div class="text-gray-400 text-[10px] font-bold uppercase">Costo Inventario</div>
                    <div class="text-2xl font-black text-dark mt-1" x-text="formatCurrency(totalInventoryValue)">$0</div>
                </div>
                <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100">
                    <div class="text-chef-500 text-[10px] font-bold uppercase">Por Vencer (FIFO)</div>
                    <div class="text-2xl font-black text-chef-500 mt-1" x-text="inventory.filter(i => checkExpiry(i.vencimiento)).length">0</div>
                </div>
            </div>

            <h3 class="font-bold text-sm mt-2 text-gray-500">Mi Alacena</h3>
            <div class="space-y-2">
                <template x-for="item in sortedInventory" :key="item.id">
                    <div class="bg-white p-3 rounded-xl border border-gray-100 shadow-sm flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-gray-50 flex items-center justify-center text-lg" x-text="getIcon(item.categoria)">üì¶</div>
                            <div>
                                <h4 class="font-bold text-sm text-dark" x-text="item.nombre">Item</h4>
                                <div class="flex gap-2 text-[10px]">
                                    <span class="text-gray-400" x-text="`${item.cantidad} ${item.unidad}`"></span>
                                    <span class="font-bold text-green-600" x-text="'Unit: ' + formatCurrency(item.precio)"></span>
                                </div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div x-show="checkExpiry(item.vencimiento)" class="flex items-center justify-end gap-1 text-[9px] font-bold text-chef-500 mb-1">
                                <i data-lucide="clock" class="w-3 h-3"></i> Vence pronto
                            </div>
                            <div class="text-[10px] text-gray-400" x-text="item.vencimiento"></div>
                        </div>
                    </div>
                </template>
            </div>
            
            <button @click="modalOpen = true" class="fixed bottom-24 right-5 bg-dark text-white p-4 rounded-full shadow-xl z-30 hover:scale-105 transition-transform">
                <i data-lucide="plus" class="w-6 h-6"></i>
            </button>
        </div>

        <div x-show="view === 'ai'" class="space-y-4 h-full flex flex-col">
            
            <div class="flex-1 bg-white rounded-2xl p-4 shadow-sm border border-gray-100 overflow-y-auto mb-2" id="chat-container">
                <div class="bg-gray-50 p-3 rounded-xl rounded-tl-none mb-3 text-xs text-gray-600">
                    <p class="font-bold mb-1">üë®‚Äçüç≥ Chef AI conectado a tu inventario.</p>
                    <p>Prueba estas funcionalidades:</p>
                    <ul class="list-disc pl-4 mt-1 space-y-1">
                        <li><b>Batch Cooking:</b> "Tengo 2 horas el domingo, ¬øqu√© cocino para la semana con lo que tengo?"</li>
                        <li><b>Gestor de Sobras:</b> "Me sobr√≥ medio pollo y arroz, dame una idea."</li>
                        <li><b>Planificaci√≥n:</b> "¬øQu√© productos est√°n por vencer y c√≥mo los uso hoy?"</li>
                    </ul>
                </div>

                <template x-for="msg in chatHistory">
                    <div :class="msg.role === 'user' ? 'bg-dark text-white self-end ml-10' : 'bg-gray-100 text-dark self-start mr-10'" class="p-3 rounded-xl mb-3 text-xs shadow-sm">
                        <div x-html="msg.html"></div>
                    </div>
                </template>

                <div x-show="isLoading" class="p-3 bg-gray-50 rounded-xl rounded-tl-none w-16">
                    <div class="loader"></div>
                </div>
            </div>

            <div class="relative shrink-0">
                <input x-model="chatInput" @keydown.enter="sendMessage" type="text" placeholder="Escribe tu consulta al Chef..." class="w-full bg-white border border-gray-200 rounded-xl px-4 py-3 text-sm focus:outline-none focus:border-chef-500 shadow-lg shadow-gray-100">
                <button @click="sendMessage" class="absolute right-2 top-2 bg-chef-500 text-white p-1.5 rounded-lg hover:bg-chef-600 transition-colors">
                    <i data-lucide="send" class="w-4 h-4"></i>
                </button>
            </div>
        </div>

    </main>

    <nav class="bg-white border-t border-gray-100 px-6 py-3 flex justify-between items-center shrink-0 z-40 pb-safe">
        <button @click="view = 'stock'" :class="view === 'stock' ? 'text-dark' : 'text-gray-300'" class="flex flex-col items-center gap-1">
            <i data-lucide="package" class="w-6 h-6"></i>
            <span class="text-[9px] font-bold uppercase">Stock</span>
        </button>
        <button @click="view = 'ai'" :class="view === 'ai' ? 'text-dark' : 'text-gray-300'" class="flex flex-col items-center gap-1">
            <i data-lucide="sparkles" class="w-6 h-6"></i>
            <span class="text-[9px] font-bold uppercase">Chef AI</span>
        </button>
    </nav>

    <div x-show="modalOpen" class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm" style="display: none;">
        <div class="bg-white w-full max-w-sm mx-4 rounded-3xl p-6 shadow-2xl relative">
            <h3 class="font-black text-xl text-dark mb-4">Nuevo Producto</h3>
            <form @submit.prevent="addItem" class="space-y-3">
                <input x-model="newItem.nombre" type="text" placeholder="Nombre (ej: At√∫n)" class="w-full bg-gray-50 rounded-xl px-4 py-3 text-sm font-bold" required>
                <div class="grid grid-cols-2 gap-3">
                    <input x-model="newItem.precio" type="number" placeholder="$ Precio" class="w-full bg-gray-50 rounded-xl px-4 py-3 text-sm font-bold" required>
                    <input x-model="newItem.vencimiento" type="date" class="w-full bg-gray-50 rounded-xl px-4 py-3 text-sm font-bold" required>
                </div>
                <div class="grid grid-cols-3 gap-3">
                    <input x-model="newItem.cantidad" type="number" placeholder="Cant." class="col-span-2 w-full bg-gray-50 rounded-xl px-4 py-3 text-sm font-bold" required>
                    <select x-model="newItem.categoria" class="w-full bg-gray-50 rounded-xl px-2 py-3 text-sm font-bold">
                        <option>Almac√©n</option><option>Carnes</option><option>L√°cteos</option><option>Verduras</option>
                    </select>
                </div>
                <div class="flex gap-2 mt-4">
                    <button type="button" @click="modalOpen = false" class="flex-1 bg-gray-100 text-gray-500 font-bold py-3 rounded-xl">Cancelar</button>
                    <button type="submit" class="flex-1 bg-dark text-white font-bold py-3 rounded-xl">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        function app() {
            return {
                // CLAVE API INTEGRADA
                apiKey: 'AIzaSyAz0SPk6FpFks7wYjZkUPLzT2DCjT58adI', 
                
                view: 'stock',
                modalOpen: false,
                isLoading: false,
                chatInput: '',
                chatHistory: [],
                
                // Inventario inicial
                inventory: JSON.parse(localStorage.getItem('gl_inventory')) || [
                    { id: 1, nombre: 'Pechuga Pollo', cantidad: 2, unidad: 'kg', precio: 5000, categoria: 'Carnes', vencimiento: '2025-02-15' },
                    { id: 2, nombre: 'Arroz', cantidad: 1, unidad: 'kg', precio: 1500, categoria: 'Almac√©n', vencimiento: '2025-06-20' },
                    { id: 3, nombre: 'Crema de Leche', cantidad: 1, unidad: 'u', precio: 2500, categoria: 'L√°cteos', vencimiento: '2025-01-25' } 
                ],
                newItem: { nombre: '', precio: '', cantidad: 1, unidad: 'u', categoria: 'Almac√©n', vencimiento: '' },

                init() {
                    lucide.createIcons();
                    this.$watch('inventory', val => localStorage.setItem('gl_inventory', JSON.stringify(val)));
                },

                // 1. L√ìGICA FINANCIERA (Costo por Plato / Valor Stock)
                get totalInventoryValue() {
                    return this.inventory.reduce((acc, item) => acc + (item.precio * item.cantidad), 0);
                },

                // 2. L√ìGICA FIFO (Esc√°ner Vencimientos)
                get sortedInventory() {
                    return this.inventory.sort((a, b) => new Date(a.vencimiento) - new Date(b.vencimiento));
                },
                checkExpiry(dateStr) {
                    const diff = new Date(dateStr) - new Date();
                    return (diff / (1000 * 60 * 60 * 24)) <= 5; // Alerta 5 d√≠as
                },

                // CRUD
                addItem() {
                    this.inventory.push({ ...this.newItem, id: Date.now() });
                    this.modalOpen = false;
                    this.newItem = { nombre: '', precio: '', cantidad: 1, unidad: 'u', categoria: 'Almac√©n', vencimiento: '' };
                    lucide.createIcons();
                },
                formatCurrency(val) {
                    return new Intl.NumberFormat('es-AR', { style: 'currency', currency: 'ARS', maximumFractionDigits: 0 }).format(val);
                },
                getIcon(cat) { return { 'Carnes': 'ü•©', 'Verduras': 'ü•¶', 'L√°cteos': 'üßÄ', 'Almac√©n': 'ü•´' }[cat] || 'üì¶'; },

                // 3. CONEXI√ìN CON GEMINI (Batch Cooking & Sobras)
                async sendMessage() {
                    if (!this.chatInput || !this.apiKey) return;
                    
                    const userText = this.chatInput;
                    this.chatHistory.push({ role: 'user', html: userText });
                    this.chatInput = '';
                    this.isLoading = true;
                    this.scrollToBottom();

                    // Preparamos el contexto para que Gemini sea "Inteligente"
                    const inventoryContext = this.inventory.map(i => 
                        `- ${i.nombre}: ${i.cantidad} ${i.unidad} (Vence: ${i.vencimiento})`
                    ).join('\n');

                    const prompt = `
                        Act√∫a como un Chef experto en gesti√≥n de hogar y Batch Cooking.
                        
                        MI INVENTARIO ACTUAL:
                        ${inventoryContext}
                        
                        PREGUNTA DEL USUARIO:
                        "${userText}"
                        
                        INSTRUCCIONES:
                        1. Si el usuario pide "Batch Cooking", crea un plan paso a paso optimizando tiempos.
                        2. Si pide "Receta de sobras", usa SOLO lo que hay en el inventario.
                        3. S√© breve, usa formato Markdown (negritas, listas).
                        4. Si hay productos por vencer (mira las fechas en el inventario), prior√≠zalos en la sugerencia.
                    `;

                    try {
                        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${this.apiKey}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                        });

                        const data = await response.json();
                        
                        if (data.error) {
                             throw new Error(data.error.message);
                        }

                        const aiText = data.candidates[0].content.parts[0].text;
                        this.chatHistory.push({ role: 'ai', html: marked.parse(aiText) });
                    } catch (error) {
                        console.error(error);
                        this.chatHistory.push({ role: 'ai', html: `<span class="text-red-500 font-bold">Error: ${error.message}. Revisa la consola.</span>` });
                    } finally {
                        this.isLoading = false;
                        this.scrollToBottom();
                    }
                },

                scrollToBottom() {
                    setTimeout(() => {
                        const container = document.getElementById('chat-container');
                        container.scrollTop = container.scrollHeight;
                    }, 100);
                }
            }
        }
    </script>
</body>
</html>
